services:
  # PostgreSQL for FileStorageService
  filestorage-db:
    image: postgres:16
    container_name: filestorage-db
    restart: always
    environment:
      POSTGRES_DB: filestorage
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - filestorage-db-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  # PostgreSQL for FileAnalysisService
  fileanalysis-db:
    image: postgres:16
    container_name: fileanalysis-db
    restart: always
    environment:
      POSTGRES_DB: fileanalysis
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - fileanalysis-db-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"

  # FileStorageService
  filestorage:
    build:
      context: ./src/FileStorageService
      dockerfile: Dockerfile
    container_name: filestorage
    restart: always
    depends_on:
      - filestorage-db
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: "Host=filestorage-db;Port=5432;Database=filestorage;Username=postgres;Password=postgres"
      FileStorage__RootPath: "/app/Files"
    volumes:
      - filestorage-files:/app/Files
    ports:
      - "8081:8080"

  # FileAnalysisService
  fileanalysis:
    build:
      context: ./src/FileAnalysisService
      dockerfile: Dockerfile
    container_name: fileanalysis
    restart: always
    depends_on:
      - fileanalysis-db
      - filestorage
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: "Host=fileanalysis-db;Port=5432;Database=fileanalysis;Username=postgres;Password=postgres"
      Services__FileStorageServiceUrl: "http://filestorage:8080/"
    ports:
      - "8082:8080"

  # ApiGateway
  apigateway:
    build:
      context: ./src/ApiGateway
      dockerfile: Dockerfile
    container_name: apigateway
    restart: always
    depends_on:
      - filestorage
      - fileanalysis
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      Services__FileStorageServiceUrl: "http://filestorage:8080/"
      Services__FileAnalysisServiceUrl: "http://fileanalysis:8080/"
    ports:
      - "8080:8080"

# Persist volumes
volumes:
  filestorage-db-data:
  fileanalysis-db-data:
  filestorage-files:
